# 云主机自动化的一点思考

做自动化的前提就是标准化，这里先对标准化方面做一下介绍。目前市面上绝大部分公司都使用云厂商的资源构建自己的业务平台，所以下以的标准是假定
使用者使云主机的前提下所做的一些选型。


## 标准化
以下两点就满足了执行自动化的前提。
- 操作系统的选择：CentOS-7操作系统于2024-06-30结束生命周期，在此之后选择RockyLinux，版本为9，官网地址：https://rockylinux.org。
- 自动化工具：ansible，目前自动化管理工具已趋于成熟，所以依然选择ansible。


## 现状
- 第一，目前主流技术已转向容器，所以云主机上可做的文章会越来越少，所以在做标准化方面主要是围绕安全基线方面和系统漏洞修复。  
- 第二，能选择云厂商SaaS服务就决不自建，如MySQL，Redis-Cluster，RocketMQ之类的服务，如自建MySQL可以会涉及数据泄密安全问题。
- 第三，尽量使用云厂商的LB替代自建的nginx/haproxy，这样不用担心nginx/haproxy漏洞修复，此外，LB更新ssl证书更加方便。
- 第四，云主机基础监控，使用云厂商即可，不再使用自建zabbix，如果确实有业务监控需求，优先考虑Prometheus方案。


## 趋势化
根据现状，所以初始化的动作可以尽量快。RockyLinux9镜像中配置ansible的ssh key，如无其他必要配置则无需增加。主机初始化仅执行一次，在初始
化过程中有一个需要讨论的点————主机名。

## 讨论点
- 主机名是否有必要全局唯一？
    - 答：主机名是否需要全局唯一，这个得看需求，例如分布式存储ceph就要求主机名唯一，涉及到监控也需要主机名唯一，如zabbix-agent主动上报。

- 如果不要求全局唯一，会有什么影响？
    - 答：如果不要求全局唯一，那么各主机之前没有任何联系，目前主机可以不用安装监控代理，直接使用云厂商的看起来是没有问题的，但是不能保证后续
        会有自定义监控需求，或者有一些大数据的应用，这些是需要主机名唯一的。

- 如果要求全局唯一，那么怎么保证全局唯一？
    - 答：从上述分析来看，主机名全局唯一是有必要执行，但是关键的问题在于，如何保证唯一呢。从当前的情况看，主机分为存量主机和新增主机，
        新增主机可以管控，存量主机目前是安装了consul-agent可以上报状态，这些是唯一的，但是没有安装的就保证不了，所以解决方法也简单，
        将存量主机安装consul-agent即可，如果遇到有重复主机名，做出修改即可。所以从分析的情况来看，执行起来并没有什么困难。

- 主机名在设置初期可以全局唯一，那么如何持续维护主机名全局唯一呢？
    - 答：在最开始设置的时候是全局唯一，那么说明一定会有某个地方存放着主机的记录，这里暂时叫主机名数据库，那如何持续维护全局唯一，一般会面临如下情况。  
    ```
    1. 如某人修改了主机名，和现在的主机名已重名了，这个如何发现？ 
    答：那一定会有某个程序启动时就依赖主机名，只要与其他主机名冲突了就启动不成功。从目前来说consul工具无疑是最好的选择。
    
    2. 如某大数据主机释放了，原来主机名是TEST-DATA-003，后来又加回来了一台主机 那么新主机的主机名是否沿用TEST-DATA-003？
    答：这种情况要分成两步，第一步是主机释放了，那么主机数据库中要删除这条记录，所以释放主机流程中需要增加释放主机名流程，
    让TEST-DATA-003空缺出来。所以就来到了第二步，新主机要沿用TEST-DATA-003主机名。
    从这个情况来看，就会引申出一个问题，就是，这些主机名称和其他主机之前都是有联系的，而不是每一个主机名都是独立存在，如每个主机名都是随机生成。
    ```

- 整体设计方案
  - ansible主机配置consul-server服务，其他主机则安装consul-agent注册到server端。很多时候，一个服务有好几台主机，如大数据主机，
    k8s宿主机，这个时候，会有一个需求，ansible要针对某一组主机做相同操作，那么上报consul-agent服务时，最好将主机名作为锚点进行
    注册服务，举个例子， test-bigdata-001，那么上报服务则为test-bigdata，去掉相应的编号即可。
  - ansible主机上配置consul-template服务，按主机上注册的服务进行分类渲染ansible的hosts文件。
  - 客户端实始化请求命令：curl http://ansible.example.com/cgi-bin/init_host.py?id=ins-8kb4sk3z&hostname=test-bigdata-001&ip=127.0.0.1，
    请求中带上ip地址，这样就可以不用登录主机就可以批量初始化了。

- 初始化脚本实施进度
  - 已完成：安装apache，默认就支持cgi-bin程序。
  - 已完成：验证init_host.sh脚本可以在server端执行shell，如ansible初始化命令，获取url请求参数。