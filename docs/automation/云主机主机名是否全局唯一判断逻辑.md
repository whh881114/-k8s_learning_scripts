# 检查hostname是否全局唯一

## 方案一
逻辑判断：当客户端请求初始化时，首先判断主机名（test-bigdata-001）是否已存在consul中，并且主机名所对应的consul-agent处于存活状态。
  - 如果存在，那么就报错退出初始化程序，同时，服务端在redis中删除test-bigdata-001锁，防止之前初始化后，其锁没有释放。
  - 如果不存在，那么需要将主机名test-bigdata-001锁定起来。
      - 当其他客户端使用相同主机名请求时，则提示此主机名处于锁定状态，那么就报错退出初始化程序。
      - 当没有其他客户端抢占主机名时，那么就等主机初始化完成后，释放主机名test-bigdata-001锁。

方案缺陷：因为consul-agent会因为网络故障会出现failed或者关机，两分钟后就不在members清单中。当新主机使用了test-bigdata-001主机名
    初始化后，原来主机开机后consul-agent则无法启动。

## 方案二
逻辑判断：方案一中的redis锁，修改向consul中写入kv作为锁，由于consul-ui无保护机制，可以将监听地址修改成127.0.0.1，使用httpd配置
    反向代理， 并且配置身份验证。除此之外，consul-agent端禁用掉ui。 对锁的逻辑修改如下。
    - kv锁存在，那就一直让锁存在，直到主机请求注销流程，以流程的方式来处理死锁。
    - kv锁不存在，那么先设置锁，直到流程流程执行完成。

方案缺陷：主机名修改了ip地址后，原主机名就是死锁了，主机就无法再次完成初始化。方案中提到了以流程的方式来处理死锁，而流程没有说明。