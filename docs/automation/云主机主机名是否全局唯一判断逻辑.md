# 检查hostname是否全局唯一

## 方案一
逻辑判断：当客户端请求初始化时，首先判断主机名（test-bigdata-001）是否已存在consul中，并且主机名所对应的consul-agent处于存活状态。
  - 如果存在，那么就报错退出初始化程序，同时，服务端在redis中删除test-bigdata-001锁，防止之前初始化后，其锁没有释放。
  - 如果不存在，那么需要将主机名test-bigdata-001锁定起来。
      - 当其他客户端使用相同主机名请求时，则提示此主机名处于锁定状态，那么就报错退出初始化程序。
      - 当没有其他客户端抢占主机名时，那么就等主机初始化完成后，释放主机名test-bigdata-001锁。

方案缺陷：因为consul-agent会因为网络故障会出现failed或者关机，两分钟后就不在members清单中。当新主机使用了test-bigdata-001主机名
    初始化后，原来主机开机后consul-agent则无法启动。


## 方案二
逻辑判断：方案一中的redis锁，修改向consul中写入kv作为锁，由于consul-ui无保护机制，可以将监听地址修改成127.0.0.1，使用httpd配置
    反向代理， 并且配置身份验证。除此之外，consul-agent端禁用掉ui。 对锁的逻辑修改如下。
- kv锁存在，那就一直让锁存在，直到主机请求注销流程，以流程的方式来处理死锁。
- kv锁不存在，那么先设置锁，直到流程流程执行完成。

方案缺陷：主机名修改了ip地址后，原主机名就是死锁了，主机就无法再次完成初始化。方案中提到了以流程的方式来处理死锁，而流程没有说明。


## 方案三
思考：云主机存活周期是，从创建到销毁，其主机名也是伴随整个周期。在生命周期中，可能存在主机迁移到别的项目使用，所以其ip地址或主机会发生
     变更，但是其ID会一直不变，所以说，主机的ID+HOSTNAME+IP是一个三元组，任一元素变更就需要释放锁，并且重新创建锁，直到主机提交销毁流程才释放锁。

逻辑判断：
- 既要有register.py脚本，也要有unregister.py脚本。register.py用于注册主机加锁，unregister.py用于注销主机和释放锁。
- ID+HOSTNAME+IP，此三元组任何元素变更，就需要执行unregister.py进行注销机和释放锁。
- 锁格式为：`LOCK__<ID>__<HOSTNAME>__<IP>`，三元组前加上`LOCK__`前缀。
- 主机初始化逻辑：
    - 先查询锁是否存在。
        - 如果存在，则报异常退出。
        - 如果不存在，那么就写入锁，直到初始化流程结束，其锁为死锁。
    - 主机三元组发生变更。
        - 查询`^LOCK__<ID>__.*`是否存在，存在即删除，然后注册新锁，直到初始化流程结束。
- 主机释放逻辑：
    - 调用register.py，释放`LOCK__<ID>__<HOSTNAME>__<IP>`死锁。

优化点：不向consul中写入kv，为了安全性要花很多配置，更好的方式是向redis中写入key即可。
        
      